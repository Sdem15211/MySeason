# Technical Implementation Flow (Current)

This document details the step-by-step technical flow of the AI Personal Color Analysis application as currently implemented. It clarifies the roles of different components, API endpoints, database interactions, and state transitions.

**Core Tables:**

- `sessions` (`src/db/schema.ts`): Tracks the state of an analysis process before completion. Contains status, temporary data pointers (image path, questionnaire answers), expiry, and ultimately links to the final analysis.
- `analyses` (`src/db/schema.ts`): Stores the final, permanent analysis results generated by the AI pipeline.

**Key Statuses (`sessionStatusEnum` in `src/db/schema.ts`):**

- `pending_payment`: Initial state upon session creation.
- `payment_complete`: Set after successful Stripe payment.
- `awaiting_selfie`: _Currently skipped in the typical flow, but exists._ The user uploads the selfie immediately after payment confirmation redirects them.
- `awaiting_questionnaire`: Set after successful selfie validation.
- `questionnaire_complete`: Set after successful questionnaire submission.
- `analysis_pending`: Set at the beginning of the `/start` endpoint.
- `analysis_complete`: Set after the analysis pipeline succeeds and results are saved.
- `analysis_failed`: Set if any part of the analysis pipeline fails.
- _(Other statuses like `payment_failed`, `selfie_validation_failed`, `expired` also exist.)_

---

## Flow Steps:

1.  **Session Initiation & Payment Request (`POST /api/v1/sessions/route.ts`)**

    - **Trigger:** User clicks "Start New Analysis" on the homepage (`src/app/page.tsx`).
    - **Action:**
      - Generates a unique UUID v4 (`sessionId`).
      - Creates a record in the `sessions` table with `id = sessionId`, `status = 'pending_payment'`, and calculates an `expiresAt` timestamp.
      - Calls the Stripe API (`stripe.checkout.sessions.create`) to create a Checkout Session.
      - Crucially, embeds the `sessionId` into the Stripe session's `client_reference_id`.
      - Sets `success_url` to redirect back to the app (e.g., `/payment-success?session_id={CHECKOUT_SESSION_ID}`).
    - **Response:** Returns `{ sessionId, checkoutUrl }` to the frontend.
    - **Frontend:** Redirects the user to the Stripe `checkoutUrl` (`window.location.href`).

2.  **Payment Confirmation (Stripe Webhook `POST /api/v1/webhooks/stripe/route.ts`)**

    - **Trigger:** Stripe sends a `checkout.session.completed` event after successful payment.
    - **Action:**
      - Verifies the webhook signature.
      - Extracts the Stripe session object from the event.
      - Retrieves the internal `sessionId` from `event.data.object.client_reference_id`.
      - Finds the corresponding record in the `sessions` table using `sessionId`.
      - Updates the session record:
        - Sets `status` to `'payment_complete'`.
        - Stores the Stripe `payment_intent` ID in `paymentIntentId`.
        - Updates `updatedAt`.
    - **Response:** Returns `200 OK` to Stripe.

3.  **Redirect to Selfie Upload (Frontend)**

    - **Trigger:** User is redirected by Stripe to the `success_url` (e.g., `/payment-success?session_id={CHECKOUT_SESSION_ID}`).
    - **Action (`src/app/payment-success/page.tsx`):**
      - Extracts the Stripe `session_id` from query parameters.
      - Calls backend `GET /api/v1/sessions/verify-payment` (passing Stripe `session_id`) to verify payment and retrieve the internal `sessionId`.
      - Redirects the user to the main upload page, passing the internal `sessionId`: `/analysis/[sessionId]/upload`. _(Assumption: `/analysis/[sessionId]/upload` route exists and renders `SelfieAnalyzer`)_.

4.  **Selfie Upload Component (`src/components/features/analysis/selfie-analyzer.tsx`)**

    - **Trigger:** Component mounts on the `/analysis/[sessionId]/upload` page.
    - **Action:**
      - User selects an image file.
      - User clicks "Upload Selfie".
      - Calls Vercel Blob's `upload()` function.
      - The `upload()` function first calls the backend authorization route specified in `handleUploadUrl`.

5.  **Blob Upload Authorization (`POST /api/v1/blob/upload/route.ts`)**

    - **Trigger:** Vercel Blob client library calls this before uploading.
    - **Action:**
      - Extracts `sessionId` from query parameters (`?sessionId=...`).
      - Finds the session in the `sessions` table.
      - Verifies session exists, `status` is `'payment_complete'`, and `expiresAt` is valid.
    - **Response:** Returns an authorization token (handled by Vercel Blob library internals) allowing direct upload from the client to Blob storage.

6.  **Image Validation (`POST /api/v1/analysis/validate/route.ts`)**

    - **Trigger:** `SelfieAnalyzer` calls this after successful blob upload, passing `{ blobUrl, sessionId }`.
    - **Action:**
      - Calls `validateSelfieImage(blobUrl)` utility (`src/lib/vision.ts`), which uses Google Cloud Vision API.
      - **If validation fails:** Calls `@vercel/blob.del(blobUrl)` to delete the blob, returns error response.
      - **If validation succeeds:**
        - Finds the session by `sessionId`.
        - Verifies session `status` is `'payment_complete'`. _(Note: Previously might have checked `awaiting_selfie`, but `payment_complete` is correct here)_.
        - Updates the `sessions` record:
          - Sets `uploadedImagePath` to `blobUrl`.
          - Sets `status` to `'awaiting_questionnaire'`.
          - Updates `updatedAt`.
    - **Response:** Returns `{ success: true }`.
    - **Frontend (`SelfieAnalyzer`):** Receives success response and redirects user to `/analysis/[sessionId]/questionnaire` using `next/navigation.useRouter`.

7.  **Questionnaire Form (`src/app/analysis/[sessionId]/questionnaire/page.tsx` & `_components/questionnaire-form.tsx`)**

    - **Trigger:** User navigates to `/analysis/[sessionId]/questionnaire`.
    - **Action:**
      - Page (`page.tsx`, Server Component) fetches session by `sessionId`, verifies status is `'awaiting_questionnaire'` and not expired. Renders the form component.
      - Form (`questionnaire-form.tsx`, Client Component) displays steps, collects answers using `react-hook-form` and validates against shared schema (`src/lib/schemas/questionnaire.ts`).
      - User clicks "Submit Questionnaire" on the final step.

8.  **Questionnaire Submission (`POST /api/v1/analysis/[sessionId]/questionnaire/route.ts`)**

    - **Trigger:** `QuestionnaireForm` submits the collected data.
    - **Action:**
      - Extracts `sessionId` from URL params.
      - Parses request body JSON.
      - Validates data using `questionnaireSchema.safeParse()`.
      - Finds session by `sessionId`.
      - Verifies session exists, not expired, and `status` is `'awaiting_questionnaire'`.
      - Updates `sessions` record:
        - Sets `questionnaireData` to the validated JSON.
        - Sets `status` to `'questionnaire_complete'`.
        - Updates `updatedAt`.
    - **Response:** Returns `{ success: true }`.
    - **Frontend (`QuestionnaireForm`):** Receives success response and redirects user to `/analysis/[sessionId]/processing`.

9.  **Analysis Processing Trigger (`src/app/analysis/[sessionId]/processing/page.tsx` & `_components/analysis-processor.tsx`)**

    - **Trigger:** User navigates to `/analysis/[sessionId]/processing`.
    - **Action (`AnalysisProcessor` Client Component):**
      - `useEffect` hook runs on mount (using `useRef` to prevent double runs).
      - Calls backend `POST /api/v1/analysis/[sessionId]/start`.
      - Sets internal component status to `'processing'`.

10. **Analysis Pipeline Execution (`POST /api/v1/analysis/[sessionId]/start/route.ts`)**

    - **Trigger:** Called by `AnalysisProcessor`.
    - **Action:**
      - Finds session by `sessionId`.
      - Verifies session exists, not expired, and `status` is `'questionnaire_complete'`.
      - Updates session `status` to `'analysis_pending'` and updates `updatedAt`.
      - **(Simulated Pipeline):**
        - Retrieves `uploadedImagePath` and `questionnaireData`.
        - _(Placeholder)_ Simulates image download/processing (`sharp`).
        - _(Placeholder)_ Simulates LLM call (`generateAnalysis` from `@/lib/ai`).
        - _(Placeholder)_ Generates a new `analysisId` (UUID).
        - _(Placeholder)_ Inserts a new record into the `analyses` table with `id = analysisId` and `result` = (LLM JSON).
      - **(On Pipeline Success):**
        - Updates `sessions` record: sets `status` to `'analysis_complete'`, links `analysisId`, updates `updatedAt`.
      - **(On Pipeline Failure):**
        - Updates `sessions` record: sets `status` to `'analysis_failed'`, updates `updatedAt`.
    - **Response:** Returns `{ success: true, analysisId }` on success, or an error response on failure.

11. **Status Polling (`src/app/analysis/[sessionId]/processing/_components/analysis-processor.tsx`)**

    - **Trigger:** `AnalysisProcessor` component's internal status is `'processing'`.
    - **Action:**
      - `useEffect` hook sets up an interval (`setInterval`).
      - Every `POLLING_INTERVAL_MS`, it calls backend `GET /api/v1/analysis/[sessionId]/status`.

12. **Status Check (`GET /api/v1/analysis/[sessionId]/status/route.ts`)**

    - **Trigger:** Called by `AnalysisProcessor` polling interval.
    - **Action:**
      - Finds session by `sessionId`.
      - Selects `status` and `analysisId`.
    - **Response:** Returns `{ success: true, status: session.status, analysisId: session.analysisId (if status is 'analysis_complete') }`.

13. **Redirect to Results (`src/app/analysis/[sessionId]/processing/_components/analysis-processor.tsx`)**

    - **Trigger:** Polling receives status `'analysis_complete'` with an `analysisId`.
    - **Action:** Component clears the polling interval and redirects user to `/analysis/[analysisId]` (using the ID from the `analyses` table).

14. **Result Display (Frontend - To Be Built)**

    - **Trigger:** User navigates to `/analysis/[analysisId]`.
    - **Action (`src/app/analysis/[analysisId]/page.tsx` - TBB):**
      - Extracts `analysisId` from URL params.
      - Fetches the record directly from the `analyses` table where `id = analysisId`.
      - Renders the content stored in the `result` JSON field.

15. **Data Cleanup (Placeholder)**
    - **Trigger:** Could happen at the end of the `/start` endpoint success path, or via a separate scheduled task/job.
    - **Action:**
      - Delete the image blob from Vercel Blob storage using `uploadedImagePath`.
      - Optionally, update the `sessions` record to nullify `uploadedImagePath` and `questionnaireData`.

---
